___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "HubSpot",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Stape",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Allow: \n- Track Custom Behavioral Events (Analytics API)\n- Track Page View (Events API / Tracking Code API)\n- Create or update a contact (Contacts API)\n- Track Ecommerce events (Deals API)",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Type",
    "radioItems": [
      {
        "value": "trackEventPageView",
        "displayValue": "Track Page View"
      },
      {
        "value": "createOrUpdateContact",
        "displayValue": "Create or Update a Contact"
      },
      {
        "value": "trackCustomBehavioralEvent",
        "displayValue": "Track Custom Behavioral Event"
      },
      {
        "value": "ecommerce",
        "displayValue": "Ecommerce event"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "Private app access token",
    "simpleValueType": true,
    "help": "You can find more information about Private app access token by \n \u003ca href\u003d\"https://developers.hubspot.com/docs/api/private-apps\" target\u003d\"_blank\"\u003ethis link\u003c/a\u003e.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "trackEventPageView",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "accountId",
    "displayName": "Account Id",
    "simpleValueType": true,
    "help": "HubSpot Account Id",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "trackEventPageView",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "email",
    "displayName": "Email",
    "simpleValueType": true,
    "help": "Email of visitor",
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "enablingConditions": [
          {
            "paramName": "type",
            "paramValue": "createOrUpdateContact",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "customBehavioralEventParametersGroup",
    "displayName": "Custom Behavioral Event Parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customBehavioralEventEventName",
        "displayName": "Event Name",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Internal name of the event-type to trigger."
      },
      {
        "type": "TEXT",
        "name": "customBehavioralEventUtk",
        "displayName": "utk",
        "simpleValueType": true,
        "help": "User token."
      },
      {
        "type": "TEXT",
        "name": "customBehavioralEventObjectId",
        "displayName": "Object Id",
        "simpleValueType": true,
        "help": "The object id that this event occurred on. Could be a contact id or a visitor id."
      },
      {
        "type": "TEXT",
        "name": "customBehavioralEventOccurredAt",
        "displayName": "Occurred At",
        "simpleValueType": true,
        "help": "The time when this event occurred (if any). If this isn\u0027t set, the current time will be used."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customBehavioralEventParameters",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "property",
            "type": "TEXT",
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "help": "Map of properties for the event in the format property internal name - property value.",
        "displayName": "Properties"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "trackCustomBehavioralEvent",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "ecommerceEventType",
    "displayName": "Ecommerce Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "login",
        "displayValue": "Login"
      },
      {
        "value": "checkout",
        "displayValue": "Checkout"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      },
      {
        "value": "removeFromCart",
        "displayValue": "Remove from cart"
      },
      {
        "value": "addToCart",
        "displayValue": "Add to cart"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "ecommerce",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "contactParametersGroup",
    "displayName": "Contact Properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "contactFirstName",
        "displayName": "First Name",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "contactLastName",
        "displayName": "Last Name",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "contactPhone",
        "displayName": "Mobile Phone",
        "simpleValueType": true
      },
      {
        "type": "GROUP",
        "name": "contactParametersAdditionalGroup",
        "displayName": "Additional Contact Properties",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "contactParameters",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Name",
                "name": "property",
                "type": "TEXT",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Value",
                "name": "value",
                "type": "TEXT"
              }
            ]
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "createOrUpdateContact",
        "type": "EQUALS"
      },
      {
        "paramName": "type",
        "paramValue": "ecommerce",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "dealParametersGroup",
    "displayName": "Deal Properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "dealExternalId",
        "displayName": "Deal External ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "dealAmount",
        "displayName": "Deal Amount",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "dealProducts",
        "displayName": "Deal Products",
        "simpleValueType": true,
        "help": "Should be formatted as an array of objects"
      },
      {
        "type": "GROUP",
        "name": "dealParametersAdditionalGroup",
        "displayName": "Additional Deal Properties",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "dealParameters",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Name",
                "name": "property",
                "type": "TEXT",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Value",
                "name": "value",
                "type": "TEXT"
              }
            ]
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "ecommerce",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const getRequestHeader = require('getRequestHeader');
const makeTableMap = require('makeTableMap');
const makeInteger = require('makeInteger');
const makeNumber = require('makeNumber');
const Promise = require('Promise');

const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = getRequestHeader('trace-id');

let type = data.type;
const eventData = getAllEventData();


if (type === 'trackEventPageView') {
  trackPageViewEvent();
} else if (type === 'trackCustomBehavioralEvent') {
  trackCustomBehavioralEvent();
} else if (type === 'createOrUpdateContact') {
  createOrUpdateContactEvent();
} else if (type === 'ecommerce') {
  ecommerceEvent();
} else {
  data.gtmOnFailure();
}


function trackPageViewEvent() {
  let url = 'https://track.hubspot.com/__ptq.gif?ct=' + encodeUriComponent('standard-page');

  if (data.accountId) url + '&a=' + encodeUriComponent(data.accountId);
  if (eventData.page_referrer) url + '&r=' + encodeUriComponent(eventData.page_referrer);
  if (eventData.page_title) url + '&t=' + encodeUriComponent(eventData.page_title);
  if (eventData.page_location) url + '&pu=' + encodeUriComponent(eventData.page_location);
  if (eventData.screen_resolution) url + '&sd=' + encodeUriComponent(eventData.screen_resolution);

  logRequest('page_view', 'GET', url, '');

  sendHttpRequest(url, (statusCode, headers, body) => {
    logResponse(statusCode, headers, body, 'page_view');

    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  }, {method: 'GET', timeout: 3500});
}

function trackCustomBehavioralEvent() {
  let url = 'https://api.hubapi.com/events/v3/send';
  let bodyData = {
    'eventName': data.customBehavioralEventEventName,
    'properties': data.customBehavioralEventParameters ? makeTableMap(data.customBehavioralEventParameters, 'property', 'value') : {},
  };

  if (data.customBehavioralEventUtk) bodyData.utk = data.customBehavioralEventUtk;
  if (data.email) bodyData.email = data.email;
  if (data.customBehavioralEventObjectId) bodyData.objectId = data.customBehavioralEventObjectId;
  if (data.customBehavioralEventOccurredAt) bodyData.occurredAt = data.customBehavioralEventOccurredAt;

  logRequest(data.customBehavioralEventEventName, 'POST', url, bodyData);

  sendHttpRequest(url, (statusCode, headers, body) => {
    logResponse(statusCode, headers, body, data.customBehavioralEventEventName);

    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  }, {headers: getRequestHeaders(), method: 'POST'}, JSON.stringify(bodyData));
}

function createOrUpdateContactEvent() {
  let url = 'https://api.hubapi.com/contacts/v1/contact/createOrUpdate/email/'+encodeUriComponent(data.email)+'/';
  let bodyData = {
    'properties': data.contactParameters
  };

  logRequest('contact_create_or_update', 'POST', url, bodyData);

  sendHttpRequest(url, (statusCode, headers, body) => {
    logResponse(statusCode, headers, body, 'contact_create_or_update');

    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  }, {headers: getRequestHeaders(), method: 'POST'}, JSON.stringify(bodyData));
}

function ecommerceEvent() {
  let contactId, dealId;

  if (data.email) {
    contactId = createOrUpdateContact();
  }

  if (data.dealExternalId) {
    dealId = createOrUpdateDeal();

    dealId.then(function(dealId) {
      if (data.dealProducts && data.dealProducts.length > 0) {
        if (data.ecommerceEventType === 'removeFromCart') {
          removeDealLineItems(dealId, data.dealProducts);
        } else {
          createDealLineItems(dealId, data.dealProducts);
        }
      }
    });
  };

  if (dealId && contactId) {
    Promise.all([dealId, contactId]).then((results) => {
      associateDealToContact(results[0], results[1]).then(() => {
        data.gtmOnSuccess();
      });
    });
  } else if (dealId) {
    dealId.then(() => {
      data.gtmOnSuccess();
    });
  } else if (contactId) {
    contactId.then(() => {
      data.gtmOnSuccess();
    });
  } else {
    data.gtmOnSuccess();
  }
}

function createDealLineItems(dealId, products) {
  getCurrentLineItems(dealId).then(function(currentLineItems) {
    for (let i = 0; i < products.length; i++) {
      let lineItemHsId = 0;
      let lineItemNotExists = true;

      if (currentLineItems.length > 0) {
        for (let l = 0; l < currentLineItems.length; l++) {
          if (currentLineItems[l].properties.hs_sku == products[i].id) {
            lineItemNotExists = false;
            lineItemHsId = currentLineItems[l].id;
          }
        }
      }

      let lineItem = products[i];

      if (products[i].quantity) lineItem.quantity = makeInteger(products[i].quantity);
      if (products[i].quantity) lineItem.num_items = makeInteger(products[i].quantity);
      if (products[i].quantity) lineItem.quantity_per_line = makeInteger(products[i].quantity);

      if (products[i].price) lineItem.price = makeNumber(products[i].price);
      if (products[i].price) lineItem.amount = makeNumber(products[i].price);

      if (products[i].discount_amount) lineItem.hs_total_discount = makeNumber(products[i].discount_amount);
      if (products[i].tax) lineItem.tax_amount = makeNumber(products[i].tax);


      if (lineItemNotExists) {
        sendEcommerceRequest('product_get', 'GET', 'https://api.hubapi.com/crm/v3/objects/products/'+products[i].id+'?idProperty=hs_sku', '').then((productId) => {
          lineItem.sku = makeInteger(products[i].id);
          lineItem.hs_sku = makeInteger(products[i].id);

          lineItem.product_id = productId;
          lineItem.hs_product_id = productId;

          sendEcommerceRequest('line_item_create', 'POST', 'https://api.hubapi.com/crm/v3/objects/line_items', {'properties': lineItem}).then((lineItemId) => {
            associateDealToLineItem(dealId, lineItemId);
          });
        });
      } else {
        sendEcommerceRequest('line_item_update', 'PATCH', 'https://api.hubapi.com/crm/v3/objects/line_items/'+lineItemHsId, {'properties': lineItem});
      }
    }
  });
}

function removeDealLineItems(dealId, products) {
  getCurrentLineItems(dealId).then(function(currentLineItems) {
    for (let i = 0; i < products.length; i++) {
      if (currentLineItems.length > 0) {
        for (let l = 0; l < currentLineItems.length; l++) {
          if (currentLineItems[l].properties.hs_sku == products[i].id) {
            sendEcommerceRequest('line_item_delete', 'DELETE', 'https://api.hubapi.com/crm/v3/objects/line_items/'+currentLineItems[l].id, '');
          }
        }
      }
    }
  });
}

function associateDealToContact(dealId, contactId) {
  let url = 'https://api.hubapi.com/crm/v3/objects/deals/'+dealId+'/associations/contact/'+contactId+'/deal_to_contact';

  return sendEcommerceRequest('deal_to_contact_association', 'PUT', url, '');
}

function associateDealToLineItem(dealId, lineItemId) {
  let url = 'https://api.hubapi.com/crm/v3/objects/deals/'+dealId+'/associations/line_items/'+lineItemId+'/deal_to_line_item';

  return sendEcommerceRequest('deal_to_line_item_association', 'PUT', url, '');
}

function getCurrentLineItems(dealId) {
  let url = 'https://api.hubapi.com/crm/v3/objects/deals/'+dealId+'/associations/line_items';

  logRequest('get_current_line_item_ids', 'GET', url, '');

  return sendHttpRequest(url, {
    headers: getRequestHeaders(),
    method: 'GET',
  }, '').then((result) => {
    logResponse(result.statusCode, result.headers, result.body, 'get_current_line_item_ids');

    if (result.statusCode >= 200 && result.statusCode < 300) {
      let currentLineItemsIds = JSON.parse(result.body).results;

      if (currentLineItemsIds.length > 0) {
        let bodyData = {
          'inputs': currentLineItemsIds,
          'properties': [
            'hs_product_id',
            'hs_sku'
          ]
        };
        url = 'https://api.hubapi.com/crm/v3/objects/line_items/batch/read';

        logRequest('get_current_line_items', 'POST', url, bodyData);

        return sendHttpRequest(url, {
          headers: getRequestHeaders(),
          method: 'POST',
        }, JSON.stringify(bodyData)).then((result) => {
          logResponse(result.statusCode, result.headers, result.body, 'get_current_line_items');

          if (result.statusCode >= 200 && result.statusCode < 300) {
            return JSON.parse(result.body).results;
          } else {
            data.gtmOnFailure();
          }
        });
      }

      return [];
    } else {
      data.gtmOnFailure();
    }
  });
}

function createOrUpdateDeal() {
  let url = 'https://api.hubapi.com/crm/v3/objects/deals/search';
  let bodyData = {
    'filterGroups': [
      {
        'filters': [
          {
            'value': data.dealExternalId,
            'propertyName': 'dealname',
            'operator': 'EQ'
          }
        ]
      }
    ]
  };

  logRequest('deal_search', 'POST', url, bodyData);

  return sendHttpRequest(url, {
    headers: getRequestHeaders(),
    method: 'POST',
  }, JSON.stringify(bodyData)).then((result) => {
    logResponse(result.statusCode, result.headers, result.body, 'deal_search');

    if (result.statusCode >= 200 && result.statusCode < 300) {
      let dealId;
      let parsedBody = JSON.parse(result.body);
      let dealData = {
        'properties': data.dealParameters ? makeTableMap(data.dealParameters, 'property', 'value') : {}
      };

      dealData.properties.dealname = data.dealExternalId;
      if (data.dealAmount) dealData.properties.amount = data.dealAmount;

      if (makeInteger(parsedBody.total) > 0) {
        dealId = sendEcommerceRequest('deal_update', 'PATCH', 'https://api.hubapi.com/crm/v3/objects/deals/'+parsedBody.results[0].id, dealData);
      } else {
        dealId = sendEcommerceRequest('deal_create', 'POST', 'https://api.hubapi.com/crm/v3/objects/deals', dealData);
      }

      return dealId;
    } else {
      data.gtmOnFailure();
    }
  });
}

function createOrUpdateContact() {
  let url = 'https://api.hubapi.com/crm/v3/objects/contacts/search';
  let bodyData = {
    'filterGroups': [
      {
        'filters': [
          {
            'value': data.email,
            'propertyName': 'email',
            'operator': 'EQ'
          }
        ]
      }
    ]
  };

  logRequest('contact_search', 'POST', url, bodyData);

  return sendHttpRequest(url, {
    headers: getRequestHeaders(),
    method: 'POST',
  }, JSON.stringify(bodyData)).then((result) => {
    logResponse(result.statusCode, result.headers, result.body, 'contact_search');

    if (result.statusCode >= 200 && result.statusCode < 300) {
      let parsedBody = JSON.parse(result.body);
      let contactData = {
        'properties': data.contactParameters ? makeTableMap(data.contactParameters, 'property', 'value') : {}
      };

      if (data.email) contactData.properties.email = data.email;
      if (data.contactFirstName) contactData.properties.firstname = data.contactFirstName;
      if (data.contactLastName) contactData.properties.lastname = data.contactLastName;
      if (data.contactPhone) contactData.properties.mobilephone = data.contactPhone;

      if (makeInteger(parsedBody.total) > 0) {
        let contactID = parsedBody.results[0].id;

        return sendEcommerceRequest('contact_update', 'PATCH', 'https://api.hubapi.com/crm/v3/objects/contacts/'+contactID, contactData);
      }

      return sendEcommerceRequest('contact_create', 'POST', 'https://api.hubapi.com/crm/v3/objects/contacts', contactData);
    } else {
      data.gtmOnFailure();
    }
  });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
      containerVersion &&
      (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function logResponse(statusCode, headers, body, eventName) {
  if (isLoggingEnabled) {
    logToConsole(JSON.stringify({
      'Name': 'HubSpot',
      'Type': 'Response',
      'TraceId': traceId,
      'EventName': eventName,
      'ResponseStatusCode': statusCode,
      'ResponseHeaders': headers,
      'ResponseBody': body,
    }));
  }
}

function logRequest(eventName, method, url, bodyData) {
  if (isLoggingEnabled) {
    logToConsole(JSON.stringify({
      'Name': 'HubSpot',
      'Type': 'Request',
      'TraceId': traceId,
      'EventName': eventName,
      'RequestMethod': method,
      'RequestUrl': url,
      'RequestBody': bodyData,
    }));
  }
}

function getRequestHeaders() {
  return {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + data.apiKey};
}

function sendEcommerceRequest(eventName, method, url, bodyData) {
  logRequest(eventName, method, url, bodyData);

  return sendHttpRequest(url, {
    headers: getRequestHeaders(),
    method: method,
  }, JSON.stringify(bodyData)).then((result) => {
    logResponse(result.statusCode, result.headers, result.body, eventName);

    if (result.statusCode === 204) {
      return true;
    } else if (result.statusCode >= 200 && result.statusCode < 300) {
      return JSON.parse(result.body).id;
    } else {
      data.gtmOnFailure();
    }
  });
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.hubapi.com/*"
              },
              {
                "type": 1,
                "string": "https://track.hubspot.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 02/05/2021, 09:39:23


